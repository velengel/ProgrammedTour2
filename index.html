<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>æ‰‹ç¶šãå‹äººç”Ÿä½“é¨“ãƒ„ã‚¢ãƒ¼2</title>
</head>

<body>
    <h1>æ‰‹ç¶šãå‹äººç”Ÿä½“é¨“ãƒ„ã‚¢ãƒ¼2</h1><br>

    <div id="all" style="margin-left:10%;margin-right:10%;">
        <input id="btn" style="width:100%;padding:10px;font-size:20px;" type="button" value="å‘½ä»¤ã‚’ã—ã‚ƒã¹ã‚‹">
        <button onClick="deviceMotionRequest()" style="width:100%;padding:10px;font-size:20px;">ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µè¨±å¯ğŸ‘Œ</button>
        <h2>
            <div id="instruction"></div>
        </h2>
        <canvas id="canvas" width="300" height="400"></canvas>
        <font size=3>

            <br>
            <div id="txt">ã“ã‚Œã‹ã‚‰ã‚ãªãŸã«ã„ãã¤ã‹ã®å‘½ä»¤ã‚’ã™ã‚‹ã®ã§ã€ã‚¹ãƒãƒ›ã‚’æŒã£ãŸã¾ã¾ãã®é€šã‚Šã«å‹•ã„ã¦ã¿ã¦ãã ã•ã„ã€‚<br>ãã®å¾Œã€ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
            <!-- <div id="txt3"></div> -->
        </font>
    </div>

    <h3>
        <div id="program"></div>
    </h3>

    <script>
        var alpha = 0, beta = 0, gamma = 0;             // ã‚¸ãƒ£ã‚¤ãƒ­ã®å€¤ã‚’å…¥ã‚Œã‚‹å¤‰æ•°ã‚’3å€‹ç”¨æ„
        var canvas = document.getElementById("canvas"); // â˜…canvasè¦ç´ ã‚’å–å¾— 
        var context = canvas.getContext("2d");
        var phase = 0;

        function deviceMotionRequest() {
            if (DeviceMotionEvent.requestPermission) {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener("deviceorientation", (dat) => {
                                alpha = -dat.alpha;  // zè»¸ï¼ˆè¡¨è£ï¼‰ã¾ã‚ã‚Šã®å›è»¢ã®è§’åº¦ï¼ˆåæ™‚è¨ˆå›ã‚ŠãŒãƒ—ãƒ©ã‚¹ï¼‰
                                beta = dat.beta;   // xè»¸ï¼ˆå·¦å³ï¼‰ã¾ã‚ã‚Šã®å›è»¢ã®è§’åº¦ï¼ˆå¼•ãèµ·ã“ã™ã¨ãƒ—ãƒ©ã‚¹ï¼‰
                                gamma = dat.gamma;  // yè»¸ï¼ˆä¸Šä¸‹ï¼‰ã¾ã‚ã‚Šã®å›è»¢ã®è§’åº¦ï¼ˆå³ã«å‚¾ã‘ã‚‹ã¨ãƒ—ãƒ©ã‚¹ï¼‰
                            });
                        }
                    })
                    .catch(console.error);
            } else {
                alert('DeviceMotionEvent.requestPermission is not found')
            }
            phase = 1;
        }

        function Speak() {
            const btn = document.getElementById("btn");
            btn.addEventListener("click", () => {
                const synth = new SpeechSynthesisUtterance();
                const txt = document.getElementById("instruction");// ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å–å¾—
                synth.text = txt.innerHTML; // è©±ã™å†…å®¹
                synth.lang = "ja-JP";   // è¨€èª
                synth.rate = 1.2;       // é€Ÿã•
                synth.pitch = 1.0;       // é«˜ã•
                synth.volume = 1.0;       // éŸ³é‡
                window.speechSynthesis.speak(synth);
            });

        }
        Speak();

        /*function Instrustion(phase) {
            switch (phase) {
                case 0:
                    speak("ã¯ã˜ã‚ã¾ã™ã€‚");
                case 1:
                    speak("ã†ã—ã‚ã‚’ã‚€ã„ã¦ãã ã•ã„ã€‚");
                    break;
                case 2:
                    speak("10ç§’é–“ã€ä¸¡æ‰‹ã‚’ä¸Šã«ä¼¸ã°ã—ã¦ãã ã•ã„ã€‚");
                    break;
            }
        }//*/


        // æŒ‡å®šæ™‚é–“ã”ã¨ã«ç¹°ã‚Šè¿”ã—å®Ÿè¡Œã•ã‚Œã‚‹ setInterval(å®Ÿè¡Œã™ã‚‹å†…å®¹, é–“éš”[ms]) ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
        var timer = window.setInterval(() => {
            displayInstruction();
            drawOrientation();    // displayData é–¢æ•°ã‚’å®Ÿè¡Œ
            displayData();
        }, 33); // 33msã”ã¨ã«ï¼ˆ1ç§’é–“ã«ç´„30å›ï¼‰

        var count = 0;
        var countup = function () {
            if (phase == 2) count++;
        }
        var id = setInterval(function () {
            countup();
            if (count > 11) {
                alert("ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹:\n int time=10;\nwhile(time>0){\ntime--;\nLookAt(smartphone);\nStretch();\n}");
                phase = 3;
                clearInterval(id);

            }
        }, 3000);

        var timer2 = window.setInterval(() => {
            countup();
        }, 1000);

        // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ displayData é–¢æ•°
        function displayData() {
            //var txt = document.getElementById("txt3");   // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹divè¦ç´ ã®å–å¾—

            var radianAlpha = alpha * Math.PI / 180;
            //txt.innerHTML = radianAlpha;
            if (phase == 1 && Math.abs(radianAlpha + 3) <= 0.3) {
                alert("ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹:\n LookAt(SmartPhone);\nTurn(Math.PI);")
                phase++;

            }
            if (phase == 3 && Math.abs(radianAlpha + 3) <= 0.3) {
                alert("ã‚ãªãŸã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã•ã‚Œã¦ã„ãŸå†…å®¹:\n LookAt(SmartPhone);\nTurn(Math.PI);")
                phase++;

            }
        }

        function drawOrientation() {
            var centerX = canvas.width / 2;            // canvasã®ä¸­å¿ƒã®Xåº§æ¨™
            var centerY = canvas.height / 2;	        // canvasã®ä¸­å¿ƒã®Yåº§æ¨™
            var radius = 100;                          // æ å††ã®åŠå¾„ãŠã‚ˆã³é‡ã®é•·ã•
            var radianAlpha = alpha * Math.PI / 180;    // è§’åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
            context.clearRect(0, 0, canvas.width, canvas.height);   // canvasã®å†…å®¹ã‚’æ¶ˆã™ clearRect(x, y, w, h)
            context.beginPath();                        // æç”»é–‹å§‹
            context.arc(centerX, centerY, radius, 0, 2 * Math.PI);  // æ å††ã‚’æã
            context.strokeStyle = "rgb(0, 0, 0)";       // æ å††ã®ç·šã®è‰²
            context.lineWidth = 2;                      // ç·šã®å¤ªã•
            context.stroke();                           // ç·šã‚’æç”»
            context.beginPath();                        // æç”»é–‹å§‹
            context.moveTo(centerX, centerY);           // ä¸­å¿ƒã«ç§»å‹•
            // ç·šã‚’å¼•ãï¼ˆcosã§xåº§æ¨™ã€sinã§yåº§æ¨™ãŒå¾—ã‚‰ã‚Œã‚‹ã€‚é•·ã•radiusã‚’æ›ã‘ã‚‹ã€‚-90åº¦ã™ã‚‹ã¨çœŸä¸Šã«å‘ãã€‚ï¼‰
            context.lineTo(centerX + Math.cos(radianAlpha - Math.PI / 2) * radius,
                centerY + Math.sin(radianAlpha - Math.PI / 2) * radius);
            context.strokeStyle = "rgb(255, 0, 0)";     // é‡ã®ç·šã®è‰²
            context.lineWidth = 5;                      // ç·šã®å¤ªã•
            context.stroke();                           // ç·šã‚’æç”»
        }

        function displayInstruction() {
            var inst = document.getElementById("instruction");
            var txt = document.getElementById("txt")
            switch (phase) {
                case 0:
                    inst.innerHTML = "å‘½ä»¤ï¼šã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µè¨±å¯ã€€ã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ";
                    break;
                case 1:
                    inst.innerHTML = "å‘½ä»¤ï¼šå¾Œã‚ã‚’å‘ã„ã¦ãã ã•ã„ã€‚";
                    txt.innerHTML = '<img src="./img/backman.png" width = 50% />';
                    break;
                case 2:
                    inst.innerHTML = "å‘½ä»¤ï¼š10ç§’é–“ä¼¸ã³ã‚’ã—ã¦ãã ã•ã„ã€‚";
                    txt.innerHTML = '<img src="./img/nobi.png" width = 50% />';
                    break;
                case 3:
                    inst.innerHTML = "å‘½ä»¤ï¼šå…ƒã®å‘ãã«æˆ»ã£ã¦ãã ã•ã„ã€‚";
                    txt.innerHTML = '<img src="./img/normal.png" width = 50% />';
                    break;
                case 4:
                    inst.innerHTML = "ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸã€‚";
                    var all = document.getElementById("all");
                    all.style.display = "none";
                    var program = document.getElementById("program");
                    program.innerHTML = "Thank you. You were programed as below:<br><br>";
                    program.innerHTML += "LookAt(SmartPhone);<br>Turn(Math.PI);<br>";
                    program.innerHTML += "int time=10;<br>while(time>0){<br>time--;<br>LookAt(smartphone);<br>Stretch();<br>}<br>";
                    program.innerHTML += "LookAt(SmartPhone);<br>Turn(Math.PI);<br>";
                    if (phase == 4) {
                        const synth = new SpeechSynthesisUtterance();
                        synth.text = "Thank you. You were programed as below:LookAt(SmartPhone);Turn(Math.PI);int time=10;while(time>0){time--;LookAt(smartphone);Stretch();}LookAt(SmartPhone);Turn(Math.PI);"; // è©±ã™å†…å®¹
                        synth.lang = "en-US";   // è¨€èª
                        synth.rate = 1.1;       // é€Ÿã•
                        synth.pitch = 1.0;       // é«˜ã•
                        synth.volume = 1.0;       // éŸ³é‡
                        window.speechSynthesis.speak(synth);
                        phase++;
                    }

                    break;



            }
        }
    </script>
</body>

</html>